---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r load-data-processed, echo=F}
chap_cur=04
#load(here('output',sprintf("%02d-processed-data.rdata",chap_cur-1)))
```

# Quality control {#qc}

First, we retrieve the LFQ-intensities of each protein hit (label-free quantitation).

```{r int-lfq}
# get lfq-peptide intensities (lfq=label-free quantitation) 
intensities = ms0 %>% dplyr::select(uniprot=majority_protein_i_ds,starts_with("lfq")) 
# Convert intensities to long format 
long_int_all = get_long_intensities(intensities) %>% mutate(int2use = log10_int)
```

## Boxplot of sample raw intensities

We want to inspect the distribution of peptide intensities between strains.
In addition, we will also observe in how many replicates each hit was quantified.

```{r boxplot-int_ub, echo=F, fig.cap='Distribution of expression for ubiquitous hits (i.e. detected in all strains)'}

# Get intensities for ubiquitously detected hits between strains
long_intensities = long_int_all %>% 
  filter(ratio_na_rep<1) %>% # At least one peptide in one replicate from a each strain
  group_by(strain) %>% mutate(nprot = n_distinct(uniprot)) %>% 
  hablar::convert(n_na_rep=int(n_na_rep)) %>% 
  arrange(n_na_rep)

# Get median expression and # proteins per strain as a function of NAs in replicates
stats_per_strain=long_intensities %>% 
  group_by(strain=toupper(strain),n_na_rep=factor(n_na_rep)) %>% 
  summarize(nprot=n_distinct(uniprot),  MAX=max(int2use), MED=median_(int2use)) %>% 
  mutate( YMAX = MAX - 0.25*as.numeric(n_na_rep))

# Compare intensities of ubiquitous hits between strains
bp=ggplot(data=long_intensities,mapping=aes(y=int2use,x=toupper(strain))) +
  ggbeeswarm::geom_quasirandom(mapping = aes(group=n_na_rep,color=as.factor(nreplicates-n_na_rep)), na.rm=TRUE) +
  geom_violin(alpha=0.2, na.rm=TRUE,draw_quantiles = c(0.25,0.5,0.75)) + 
  geom_text(data=stats_per_strain,aes(label=nprot,color=nreplicates-n_na_rep,x=strain,y=YMAX),show.legend = F) +
  ylim(5,max_(stats_per_strain$MAX)) +
  ylab('Peptides intensities (log10)') + labs(x='Strains', colour='expressed in # replicates') +
  theme_pubclean() + grids(axis = 'y') + theme(axis.text = element_text(size=12)) +
  scale_color_canva(palette = "Pool party",limits=rev)
plot(bp)

BY_STRAINS = group_by(long_intensities,strain=toupper(strain)) %>% 
             summarize(median_exp=median_(int2use)) %>%
             data.table::transpose(make.name = "strain", keep.names = "strain name") 

BY_REP = group_by(long_intensities, n_replicates=as.integer(4-n_na_rep)) %>% 
  summarize(median_exp=median_(int2use)) %>% 
  data.table::transpose(make.name = 'n_replicates',keep.names = '# replicates')

library(kableExtra)
TAB_STRAINS_EXP = kbl( BY_STRAINS ,digits = 2) %>%
  kable_paper("striped", full_width = F) %>% kable_styling()

TAB_REP_EXP = kbl( BY_REP, digits=2 ) %>%
  kable_paper("striped", full_width = F) %>% kable_styling()  

```

**The distribution of peptide intensities between strains is relatively similar between strains:**
`r TAB_STRAINS_EXP`

**However, the peptide intensities can vary widely (1 unit = 10-fold) when a hit is not detected across all replicates:**
`r TAB_REP_EXP`

**On average, peptide intensities increase when a hit is found in more than one replicate**

We then look at hits quantified as a function of the number of strains in which 
at least one peptide was quantified. (non-ubiquitous hits)

```{r missing-hit, echo=F, fig.cap='Distribution of expression for hits not detected in all strains',out.width='100%'}
pep_missing = long_int_all %>%
  filter(ratio_na_rep==1) %>% 
  dplyr::select(-c(bio,tech)) %>% 
  distinct()

hit_missing = pep_missing$uniprot

bp_miss= long_int_all %>% arrange(n_na_strains) %>% 
         dplyr::filter(has_missing_strains) %>%
  ggplot(mapping=aes(y=int2use,x=8-n_na_strains)) +
  geom_violin(mapping=aes(fill=factor(n_na_strains)),
              alpha=0.2, na.rm=TRUE,draw_quantiles = c(0.25,0.5,0.75),color='black',show.legend = F) +
  geom_text(aes(label=nprot_miss),y=12,check_overlap = T,col='red') + ylim(5,12) +
  ylab('Peptides intensities (log10)') + labs(x='expressed across # strains') +
  scale_x_continuous(breaks=0:8) +
  theme_pubclean() + grids(axis = 'y') + theme(axis.text = element_text(size=12))
  
plot(bp_miss)

stat_per_miss = long_int_all %>% 
  dplyr::select(n_na_strains,nprot) %>%
  mutate(n_strains= nstrains-n_na_strains) %>%
  distinct() %>% 
  ungroup() %>%
  arrange(n_strains) %>%
  mutate( f_exp = 100*nprot/sum(nprot),
          pc_exp = sprintf("%.1f%%",f_exp),
          pc_cum = sprintf("%.1f%%",cumsum(f_exp))
          ) %>%
  arrange(desc(n_strains)) %>%
  mutate(pc_cum_desc = sprintf("%.1f%%",cumsum(f_exp))) %>%
  dplyr::select(nprot,n_strains,pc_exp,pc_cum,pc_cum_desc)


TAB_EXP_STRAIN = kbl(stat_per_miss,digits = 2, align = 'l',
                     col.names=c('# proteins','# expressing strains','% quantified','cum. %','cum. % (decreasing)')) %>%
  kable_paper("striped", full_width = F) %>% kable_styling()

```

`r TAB_EXP_STRAIN`

**Proteins expressed across less strains have lower median peptide intensity.**
Nevertheless, almost two thirds (*64.3%*) of the protein hits were detected in all strains.
About 87% protein hits were expressed in the majority of strains (at least 5 out of 8 strains).

## Number of missing values in samples

Furthermore, we can check whether the proportion of missing values is equally 
distributed among all samples.

```{r na-samples, echo=F,  out.width='100%', fig.cap='Number of quantified intensities across samples'}
# Count hits with NA in samples/groups
na_int= intensities %>% 
        group_by(uniprot) %>%
        summarize(across(all_of(paste0("lfq_intensity_",samples)), is.na ) )
colnames(na_int) = c('uniprot',samples)

ComplexUpset::upset(data=as.data.frame(1-na_int[,-1]),intersect=samples,
      name='intensity quantified', min_degree=5, sort_sets=F, 
      width_ratio=0.1,min_size=10, keep_empty_groups=F, wrap=TRUE,
         base_annotations=list(
          'Number of hits'=ComplexUpset::intersection_size(text_colors=c(on_background='red', on_bar='yellow'),text=list(angle=0,hjust=0.45,size=2.8))
           + annotate( geom='text', x=Inf, y=Inf, label=paste('Total hits:', nrow(na_int)), vjust=1, hjust=1 )
         ),
)

```


## Coefficient of variations

```{r boxplot-cv, echo=F, fig.cap='Coefficient of variations (%) in each sample and per strains before and after processing data (filtering and normalization)'}
CV_raw= long_int_all %>%
    group_by(uniprot,strain,bio) %>% mutate(cv_bio = 100*sd_(int2use)/mean_(int2use)) %>%
    group_by(uniprot,strain) %>% mutate(cv_strain = 100*sd_(int2use)/mean_(int2use)) %>% 
    dplyr::select(uniprot,strain,bio,cv_bio,cv_strain) %>% distinct() %>%
    mutate(biological_rep=paste0(strain,"-",bio)) %>% drop_na()

cv1 = ggplot(CV_raw) + 
  geom_violin(aes(y=cv_strain,x=strain,fill=strain),
              trim=T,draw_quantiles = c(0.25,0.75), na.rm = T,show.legend = F) + 
  theme(axis.text.x = element_text(angle=90,vjust = 0.6)) + ylab('%CV (raw) within strains')
cv2 = ggplot(CV_raw) + 
  geom_violin(aes(y=cv_bio,x=biological_rep,fill=biological_rep),
              trim=T,draw_quantiles = c(0.25,0.75), na.rm = T, show.legend = F) +
  theme(axis.text.x = element_text(angle=90,vjust = 0.6)) + ylab('%CV (raw) within biological replicates')

CV1_stats = CV_raw %>% group_by(strain) %>% summarize(min=min(cv_strain),q25=q25(cv_strain), md=median_(cv_strain), q75=q75(cv_strain), max=max(cv_strain))
CV2_stats = CV_raw %>% group_by(strain) %>% summarize(min=min(cv_bio),q25=q25(cv_bio), md=median_(cv_bio), q75=q75(cv_bio), max=max(cv_bio))

CV_norm= long_int_norm %>%
    group_by(uniprot,strain,bio) %>% mutate(cv_bio = 100*sd_(int2use)/mean_(int2use)) %>%
    group_by(uniprot,strain) %>% mutate(cv_strain = 100*sd_(int2use)/mean_(int2use)) %>% 
    dplyr::select(uniprot,strain,bio,cv_bio,cv_strain) %>% distinct() %>%
    mutate(biological_rep=paste0(strain,"-",bio)) %>% drop_na()

cv3 = ggplot(CV_norm) + 
  geom_violin(aes(y=cv_strain,x=strain,fill=strain),
              trim=T,draw_quantiles = c(0.25,0.75), na.rm = T,show.legend = F) + 
  theme(axis.text.x = element_text(angle=90,vjust = 0.6)) + ylab('%CV (normalized) within strains')
cv4 = ggplot(CV_norm) + 
  geom_violin(aes(y=cv_bio,x=biological_rep,fill=biological_rep),
              trim=T,draw_quantiles = c(0.25,0.75), na.rm = T, show.legend = F) +
  theme(axis.text.x = element_text(angle=90,vjust = 0.6)) + ylab('%CV (normalized) within biological replicates')

plot((cv1 | cv2) / (cv3 | cv4))

CV3_stats = CV_norm %>% group_by(strain) %>% summarize(min=min(cv_strain),q25=q25(cv_strain), md=median_(cv_strain), q75=q75(cv_strain), max=max(cv_strain))
CV4_stats = CV_norm %>% group_by(strain) %>% summarize(min=min(cv_bio),q25=q25(cv_bio), md=median_(cv_bio), q75=q75(cv_bio), max=max(cv_bio))

kbl(CV1_stats)
kbl(CV2_stats)
kbl(CV3_stats)
kbl(CV4_stats)
```


## Compare all-vs-all expression

### Scatterplots

```{r scatterplot-all, fig.path='plot/', fig.show='hold', warning=F, fig.height=15, fig.width=15, out.width='100%'}
# scatterplots between all samples
scmat_all=draw_scatterplots(datain=int_all)
print(scmat_all)

```

### Heatmap correlation 

```{r heatmap-all, fig.path='plot/', fig.show='hold', warning=F, fig.height=15, fig.width=15, out.width='100%' }
# heatmap correlation
cs_all=compute_samples_correlation(int_all)
COR_RANGE = range( cs_all[row(cs_all) == (col(cs_all) - 1)] )

by_sample = df.group %>% column_to_rownames("sample")
hm_all=draw_heatmap_samples(mcor = cs_all,df.group=by_sample,col.group = col.group)
```


The heatmap correlations of all samples show the high correlation of expression 
between replicates and between most strains:
`r sprintf("[%.3f - %.3f]",COR_RANGE[1],COR_RANGE[2])`

The expression from the 1st biological replicates of strains CQC and CMP seem
slighlty less correlated to the other samples.

### Principle Component Analysis

Finally, the PCA  reveals the distance between each sample.

```{r pca-all, fig.path='plot/', fig.show='hold', warning=F, out.width='100%'}
int_all_scaled = scale(int_all,center=T, scale = T)
make_pca(na.omit(int_all_scaled), with_labels=T,col_by_group=1:4)
```


```{r save-data-qc, echo=F}
save.image(here('output',sprintf("%02d-quality-control.rdata",chap_cur)))
```