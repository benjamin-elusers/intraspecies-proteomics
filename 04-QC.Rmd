```{r load-data-processed, echo=F}
chap_cur=04
#load(here('output',sprintf("%02d-processed-data.rdata",chap_cur-1)))
```

# Quality control {#qc}

First, we retrieve the LFQ-intensities of each protein hit (label-free quantitation).

```{r int-lfq}
# get lfq-peptide intensities (lfq=label-free quantitation) 
intensities = ms1 %>% dplyr::select(uniprot=majority_protein_i_ds,starts_with("lfq")) 
# Convert intensities to long format 
long_int_all = get_long_intensities(intensities) %>% mutate(int2use = log10_int)
```

## Boxplot of sample raw intensities

We want to inspect the distribution of peptide intensities between strains.
In addition, we will also observe in how many replicates each hit was quantified.

*The distribution of peptide intensities between all strains does not show strong differences of expression:*

```{r boxplot-int_ub, echo=F, fig.cap='Distribution of expression for ubiquitous hits (i.e. detected in all strains)'}

# Get intensities for ubiquitously detected hits between strains
long_intensities = long_int_all %>% 
  filter(ratio_na_rep<1) %>% # At least one peptide in one replicate from a each strain
  group_by(strain) %>% mutate(nprot = n_distinct(uniprot)) %>% 
  hablar::convert(n_na_rep=int(n_na_rep)) %>% 
  arrange(n_na_rep)

# Get median expression and # proteins per strain as a function of NAs in replicates
stats_per_strain=long_intensities %>% 
  group_by(strain=toupper(strain),n_na_rep=factor(n_na_rep)) %>% 
  summarize(nprot=n_distinct(uniprot),  MAX=max(int2use), MED=median_(int2use)) %>% 
  mutate( YMAX = MAX - 0.25*as.numeric(n_na_rep))

# Compare intensities of ubiquitous hits between strains
bp=ggplot(data=long_intensities,mapping=aes(y=int2use,x=toupper(strain))) +
  ggbeeswarm::geom_quasirandom(mapping = aes(group=n_na_rep,color=as.factor(nreplicates-n_na_rep)), na.rm=TRUE) +
  geom_violin(alpha=0.2, na.rm=TRUE,draw_quantiles = c(0.25,0.5,0.75)) + 
  geom_text(data=stats_per_strain,aes(label=nprot,color=nreplicates-n_na_rep,x=strain,y=YMAX),show.legend = F) +
  ylim(5,max_(stats_per_strain$MAX)) +
  ylab('Peptides intensities (log10)') + labs(x='Strains', colour='expressed in # replicates') +
  theme_pubclean() + grids(axis = 'y') + theme(axis.text = element_text(size=12)) +
  scale_color_canva(palette = "Pool party",limits=rev)
plot(bp)

BY_STRAINS = group_by(long_intensities,strain=toupper(strain)) %>% 
             summarize(median_exp=median_(int2use)) %>%
             data.table::transpose(make.name = "strain", keep.names = "strain name") 

BY_REP = group_by(long_intensities, n_replicates=as.integer(4-n_na_rep)) %>% 
  summarize(median_exp=median_(int2use)) %>% 
  data.table::transpose(make.name = 'n_replicates',keep.names = '# replicates')

TAB_STRAINS_EXP = kbl( BY_STRAINS ,digits = 2) %>%
  kable_paper("striped", full_width = F) %>% kable_styling()

TAB_REP_EXP = kbl( BY_REP, digits=2 ) %>%
  kable_paper("striped", full_width = F) %>% kable_styling()  

```

The median peptide intensity are remarkably similar (~10^8^ or 7.9 in log10) between strains:
`r TAB_STRAINS_EXP`

*However, the peptide intensities can vary widely (>10-fold) when a hit is not detected across all replicates:*
`r TAB_REP_EXP`

**On average, peptide intensities are higher when a hit is found in more than one replicate**

## Barplot of missing hits per samples

The following barplot shows the range of missing hits per samples.

```{r missing-hit-samples,echo=F, fig.cap='Count of missing hits per samples',out.width='100%'}
count_NA_samples= pivot_longer(intensities,   -uniprot,
                           names_to = c('sample','strain','bio','tech','day'),
                           names_pattern = "(([^_]+)_([^_]+)_([^_]+)_([^_]+))",
                           names_prefix = 'lfq_intensity_',
                           values_to='int') %>% 
  group_by(sample) %>% 
  summarize(n_na=sum(is.na(int))) %>% 
  dplyr::left_join(df.group %>% mutate(sample=tolower(sample))) %>% 
  mutate(is_outlier = strain %in% c("CQC","CMP") & biorep=="R1")

mean_na_outliers = mean_(count_NA_samples %>% dplyr::filter(is_outlier) %>% pull(n_na))
mean_na = mean_(count_NA_samples %>% dplyr::filter(!is_outlier) %>% pull(n_na))

bp_na = ggplot(count_NA_samples,aes(x=sample,label=sample)) + 
        geom_col(aes(y=n_na,fill=strain,col=is_outlier)) + 
        geom_text(data=subset(count_NA_samples,!is_outlier),aes(y=0),angle=90,hjust=-0.1)+
        geom_text(data=subset(count_NA_samples,is_outlier),aes(y=0),angle=90,hjust=-0.1,col='red')+
        ylab('# NAs') +
        theme(axis.text.x = element_blank(),axis.ticks = element_blank()) +
        geom_hline(yintercept = mean_na_outliers,col='red',linetype=2) + 
        geom_hline(yintercept = mean_na) + scale_color_manual(values = c('TRUE'='red'))

  
plot(bp_na)
```

CQC and CMP are the two strains containing the most missing values. 

Particularly, the first biological replicate of those strains have twice more missing
protein intensities (`r mean_na_outliers` hits so 10-16% NAs) while the rest of the samples
have on average about only `r mean_na` hits missing (4% to 9% NAs).

We then look at hits quantified as a function of the number of strains in which 
at least one peptide was quantified. (non-ubiquitous hits)

```{r missing-hit, echo=F, fig.cap='Distribution of expression for hits not detected in all strains',out.width='100%'}
pep_missing = long_int_all %>%
  filter(ratio_na_rep==1) %>% 
  dplyr::select(-c(bio,tech)) %>% 
  distinct()

hit_missing = pep_missing$uniprot

bp_miss= long_int_all %>% arrange(n_na_strains) %>% 
         dplyr::filter(has_missing_strains) %>%
  ggplot(mapping=aes(y=int2use,x=8-n_na_strains)) +
  geom_violin(mapping=aes(fill=factor(n_na_strains)),
              alpha=0.2, na.rm=TRUE,draw_quantiles = c(0.25,0.5,0.75),color='black',show.legend = F) +
  geom_text(aes(label=nprot_miss),y=12,check_overlap = T,col='red') + ylim(5,12) +
  ylab('Peptides intensities (log10)') + labs(x='expressed across # strains') +
  scale_x_continuous(breaks=0:8) +
  theme_pubclean() + grids(axis = 'y') + theme(axis.text = element_text(size=12))
  
plot(bp_miss)

stat_per_miss = long_int_all %>%
  dplyr::select(n_na_strains,nprot,int2use) %>%
  mutate(n_strains= nstrains-n_na_strains) %>%
  group_by(n_strains) %>% mutate(md_exp = median_(int2use)) %>%
  ungroup() %>% dplyr::select(-int2use) %>%
  distinct() %>% 
  arrange(n_strains) %>% 
  mutate(
          f_exp = 100*nprot/sum(nprot),
          pc_exp = sprintf("%.1f%%",f_exp),
          pc_cum = sprintf("%.1f%%",cumsum(f_exp))
          ) %>%
  arrange(desc(n_strains)) %>%
  mutate(pc_cum_desc = sprintf("%.1f%%",cumsum(f_exp))) %>%
  dplyr::select(nprot,n_strains,md_exp,pc_exp,pc_cum,pc_cum_desc)


TAB_EXP_STRAIN = kbl(stat_per_miss,digits = 2, align = 'l',
                     col.names=c('# proteins','# expressing strains','median exp. (log10)','% quantified','cum. %','cum. % (decreasing)')) %>%
  kable_paper("striped", full_width = F) %>% kable_styling()

```

`r TAB_EXP_STRAIN`

**Proteins expressed across less strains have lower median peptide intensity.**
Nevertheless, almost two thirds (*66.5%*) of the protein hits were detected in all strains.
About 86% protein hits were expressed in the majority of the strains (at least 5 out of 8 strains).

## Number of missing values in samples

Furthermore, we can check whether the proportion of missing values is equally 
distributed among all samples.

```{r na-samples, echo=F, fig.cap='Number of quantified intensities across samples', height=18, out.width='100%', width=18}
# Count hits with NA in samples/groups
na_int= intensities %>% 
        group_by(uniprot) %>%
        summarize(across(all_of(paste0("lfq_intensity_",samples)), is.na ) )
colnames(na_int) = c('uniprot',samples)

ComplexUpset::upset(data=as.data.frame(1-na_int[,-1]),intersect=samples,
      name='intensity quantified', min_degree=5, sort_sets=F, 
      width_ratio=0.1,min_size=10, keep_empty_groups=F, wrap=TRUE,
         base_annotations=list(
          'Number of hits'=ComplexUpset::intersection_size(text_colors=c(on_background='red', on_bar='yellow'),text=list(angle=0,hjust=0.45,size=2.8))
           + annotate( geom='text', x=Inf, y=Inf, label=paste('Total hits:', nrow(na_int)), vjust=1, hjust=1 )
         ),
)

```


## Coefficient of variations

Coefficient of variations correspond to the percent of variance relative to the mean.
The following boxplots show how variable protein expression is, across strains
or across biological replicates, before and after normalization.

```{r boxplot-cv, echo=F, fig.cap='Coefficient of variations (%) in each sample and per strains before and after processing data (filtering and normalization)', width=18,height=18}

CV_raw = calculate_cv(long_int_all,by_bio = T)
box_cv_raw = draw_boxcv(CV_raw,by_bio = T)
CV_norm = calculate_cv(long_int_norm,by_bio = T)
box_cv_norm = draw_boxcv(CV_norm,by_bio = T)

plot(box_cv_raw / box_cv_norm)

show_table_cv(CV_raw,by_bio = F)
show_table_cv(CV_raw,by_bio = T)

show_table_cv(CV_norm,by_bio = F)
show_table_cv(CV_norm,by_bio = T)
```

## Expression distributions

To highlight the strength of normalization, we also show the density distribution of 
expression before and after normalization using each of the following normalization methods:

`r cat("",ul_normalizations)`

```{r exp_density,width=12,height=12}
draw_normalization_density(int_raw,int_lfq,df.group)
```

## Compare all-vs-all expression

### Scatterplots

```{r scatterplot-all, fig.path='plot/', fig.show='hold', warning=F, fig.height=15, fig.width=15, out.width='100%'}
# scatterplots between all samples
scmat_all=draw_scatterplots(datain=int_all)
print(scmat_all)

```

### Heatmap correlation 

```{r heatmap-all, fig.path='plot/', fig.show='hold', warning=F, fig.height=15, fig.width=15, out.width='100%' }
# heatmap correlation
cs_all=compute_samples_correlation(int_all)
COR_RANGE = range( cs_all[row(cs_all) == (col(cs_all) - 1)] )

by_sample = df.group %>% column_to_rownames("sample")
hm_all=draw_heatmap_samples(mcor = cs_all,df.group=by_sample,col.group = col.group)
```


The heatmap correlations of all samples show the high correlation of expression 
between replicates and between most strains:
`r sprintf("[%.3f - %.3f]",COR_RANGE[1],COR_RANGE[2])`

The expression from the 1st biological replicates of strains CQC and CMP seem
slighlty less correlated to the other samples.

### Principle Component Analysis

Finally, the PCA  reveals the distance between each sample.

```{r pca-all, fig.path='plot/', fig.show='hold', warning=F, out.width='100%'}
int_all_scaled = scale(int_all,center=T, scale = T)
make_pca(na.omit(int_all_scaled), with_labels=T,col_by_group=1:4)
```


```{r save-data-qc, echo=F}
save.image(here('output',sprintf("%02d-quality-control.rdata",chap_cur)))
```