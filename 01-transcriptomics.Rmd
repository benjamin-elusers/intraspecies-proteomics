```{r load-setup-data, echo=F}
chap_cur=01
chap_num = sprintf("%02d-",chap_cur)
load(here::here('output',sprintf("%02d-yeast-data.rdata",chap_cur-1)))
```

# Transcriptomics {.tabset .tabset-pills}

## Summary

During evolution, mutations arise in genomes, potentially affecting every gene
and protein at every site over time. Degrees of sequence divergence within
populations and between species reflect the interplay between several
interconnected constraints (e.g., genomic, transcriptional, functional,
biophysical, structural, environmental…) and underlie phenotypic diversity and
organism fitness. Protein expression is the main determinant of a protein’s
sequence conservation (e.g., the more a gene is expressed, the more its sequence
is conserved). Although this expression-conservation correlation is well
established, its mechanistic origin is not well understood.

In this perspective, analyzing variation of gene expression across every layer
could reveal the key processes driving evolution among several yeast (*S. cerevisiae*) 
isolates sharing an almost identical genetic background, except for
newly acquired mutations, notably in protein-coding genes (e.g. Single
Nucleotide Variations).

Gene expression is a multi-layered phenomenon in which variations occur 
differently at each step of the protein synthesis and life
(transcription, translation and protein abundance). The exploration of each
of these steps is therefore essential to define the constraints affecting the
final protein abundance. Given this, we sought to understand how individuals
differ in terms of translational regulation and if the translational variation
is related to the transcriptional variation. 

Therefore, we performed a joint exploration of RNA-seq, ribosome and proteomics
profiling on 8 natural *Saccharomyces cerevisiae* yeast isolates with 
widely diverse genetic and ecologic origins. We found that the evolutionary
constraints on gene expression showed different magnitudes depending on the
expression layer. Specifically, expression variations tended to be 10% lower at
the translational level, which was related to a phenomenon called
post-transcriptional buffering. This phenomenon was more likely to affect some
specific genes such as essential genes as well as genes related to protein
complexes. Surprisingly, genes being preferentially affected by the
post-transcriptional buffering tended to be less expressed than the genes not
affected by this phenomenon. Together, these results highlight that variations
in gene expression were shaped differently depending on the expression level and
multiple factors, including certain functional and physical constraints. We have
also been collecting proteomics data for these 8 isolates, which will allow us
to assess with high confidence the balance between biophysics (in particular
abundance) versus function on protein evolution.


## Our datasets

**_RNA-seq & Ribo-seq of 8 natural isolates of Saccharomyces cerevisiae_**

We performed both ribosome profiling and RNA sequencing on eight _S. cerevisiae_
natural isolates coming from very diverse ecological environments and being
genetically strongly different ([Peter et al.,2018](https://www.nature.com/articles/s41586-018-0030-5)).
These isolates were cultivated in Synthetic Complete (SC) up to mid-log phase, 
harvested and flash-frozen. The RNA-seq and Ribo-seq experiment was performed in
collaboration with the Riken institute in Japan.

```{r load-rna-ribo-data}
## Our dataset
isolates = c('CPI','CMP','AMH','CQC','BPL','BTT','BED','BAN')
RNA_seq_data = readRDS(here("data",'RNA_seq.RDS'))
Ribo_seq_data = readRDS(here("data",'Ribo_seq.RDS'))
n = nrow(RNA_seq_data)
strains = fread(here("data",'strains.csv'),data.table = F)
strains = strains[strains$`Standardized name`%in%isolates,c(1,2,3,4,9,10,11,16)]
library(DT)
datatable(strains, rownames = FALSE, caption = NULL,
               filter = "top", escape = FALSE, style = "default",
               width = NULL, height = NULL)
```

Our data encompassed **`r n`** genes. The data was normalized using TPM
normalization where for each gene in each isolate, we divided the raw count by
the ORF length and we applied a per million factor (total read count /
1,000,000)


```{r corr-rna-ribo}

p1= ggcorr(RNA_seq_data ,method = c("everything", "spearman"), label = T, label_round = 2, midpoint = 0.75, limits = c(0.6,1), size = 2)+
  ggtitle('RNA-seq correlation matrix')
p2=ggcorr(Ribo_seq_data ,method = c("everything", "spearman"), label = T, label_round = 2, midpoint = 0.75, limits = c(0.6,1), size = 2)+
  ggtitle('Ribo-seq correlation matrix')

grid.arrange(p1,p2, ncol=2)
```

We also calculated a Translation efficiency value which correspond, for each
gene in each isolate, to the Ribo-seq TPM value divided by the RNA-seq TPM
value. In brief, this represents how well a transcript will be used for
translation.

## Overlap with proteomic

```{r overlap-proteomics}

proteomic_WIS2 = fread(here::here('output','median-normalized.txt'), data.table = F)
n = nrow(proteomic_WIS2)
a = fread(here::here('output','proteomics-normalized-log10_intensities.tsv'))
rownames(proteomic_WIS2)= a$UNIPROT

prot_gene_name = fread(here::here('output','test.csv'), fill = T, data.table = F) %>% 
                  mutate(Chromosome = recode(Chromosome,'(3)'=V8) ) %>% 
                  dplyr::select(-V8) %>%
                  dplyr::filter(!duplicated(prot_names)) %>% 
                  column_to_rownames('prot_names')

# Calculate mean of normalized intensity per strain
a = lapply(isolates,function(i){
  i<<-tolower(i)
  i = tolower(i)
  b = proteomic_WIS2[,grep(i,colnames(proteomic_WIS2))]
  return(rowMeans(b,na.rm = T))
})
a= setNames(a,isolates)
a = as.data.frame(a)
rownames(a)= rownames(proteomic_WIS2)
proteomic_WIS_mean2 = a
rownames(proteomic_WIS_mean2) = rownames(proteomic_WIS2)
proteomic_WIS_mean2=na.omit(proteomic_WIS_mean2)

# 
b=prot_gene_name[!(duplicated(prot_gene_name$prot_names)),]
rownames(b)=b$prot_names
a  =proteomic_WIS_mean2
a = a[rownames(a)%in%b$prot_names,]
rownames(a)=b[rownames(a),"ID"]
proteomic_WIS_mean_filtered2=a


temp = intersect(rownames(proteomic_WIS_mean_filtered2),rownames(RNA_seq_data))
a = cbind(proteomic_WIS_mean_filtered2[temp,],cbind(RNA_seq_data[temp,],Ribo_seq_data[temp,]))
for(i in c(0,8,16)){
  if(i==0)(colnames(a)[1:8]=paste(colnames(a)[1:8],'Prot',sep='_'))
  if(i==8)(colnames(a)[i+(1:8)]=paste(colnames(a)[i+(1:8)],'RNA',sep='_'))
  if(i==16)(colnames(a)[i+(1:8)]=paste(colnames(a)[i+(1:8)],'Ribo',sep='_'))
}

e= a
e = log2(e)

a = nrow(e)
boxplot(e)
```

Our proteomic data encompassed **`r n`** genes. The overlap between the two datasets encompassed **`r a`** (after several filtration of some missing values). The data between the different data sets needed to be normalized so it can be studied together (see graph above). We therefore performed quantile normalization to obtain equally distributed data (see below)

```{r dataset4}
df_rank <- apply(e,2,rank,ties.method="min")
df_sorted <- data.frame(apply(e, 2, sort))
df_mean <- apply(df_sorted, 1, mean)
index_to_mean <- function(my_index, my_mean){
  return(my_mean[my_index])
}

df_final2 <- apply(df_rank, 2, index_to_mean, my_mean=df_mean)
boxplot(df_final2)
```

# Post transcriptional buffering {.tabset .tabset-pills}

The post-transcriptional buffering (PTB) is a phenomenon where transcriptional variations tend to be buffered as the expression process progresses (add ref). It has been observed in different situations... To be completed

It is possible to detect this phenomenon in different ways:

## Correlation between isolate

Using the quantile normalized data, we performed Spearman correlation between all the isolate profile in each expression level separately (using the median value of the replicate for the proteomic data)

Comparing the correlation values, it reveals that the profiles tended to be more and more similar as the expression process progresses (increasing of the correlation coefficient values), bringing a first proof of the presence of the phenomenon across our 8 isolates. 

```{r PTB1}

d= list()

a= df_final2[, grep('Prot', colnames(df_final2))]
d[['prot']]=cor(a,method = 's')[lower.tri(cor(a,method = 's'))]
a= df_final2[, grep('RNA', colnames(df_final2))]
d[['RNA']]=cor(a,method = 's')[lower.tri(cor(a,method = 's'))]
a = df_final2[, grep('Ribo', colnames(df_final2))]
d[['Ribo']]=cor(a,method = 's')[lower.tri(cor(a,method = 's'))]
d= as.data.frame(d)
d= melt(d)
d$variable=factor(d$variable,levels = c('RNA','Ribo','prot'))
b = combn(as.character(unique(d$variable)),2)
b = apply(b,2,function(i){
  return(list(i[1],i[2]))
})
lapply(1:length(b),function(i){
  b[[i]]<<-unlist(b[[i]])
})


ggplot(d,aes(x=variable, y=value,fill=variable))+
  geom_boxplot()+
  theme_classic()+
  xlab('')+
  ylab('Rho')+
  stat_compare_means(comparisons = b)
```


## Variation quantification 

It is also possible to explore PTB by quantifying the variation in each pairwise comparison. Basically, for each gene in each isolate pairwise comparison, we use the absolute value of the log2 transformed fold to represent the intensity of the expression variation between the 2 isolates. The more this value increases, the more a gene displays variable regulation between isolate.

We calculated this value in each pairwise comparison, for each gene and at each expression level. We found that the intensities of the variations were decreasing as long as the expression process progresses, supporting once again the presence of the PTB phenomenon in our dataset.

```{r PTB2}

a = combn(isolates,2)

b = pbapply(a,2,function(i){
  i<<-i
  d = list()
  e = df_final2[,grep(pattern = paste(i,collapse = '|'),colnames(df_final2))]
  
  c = e[,1:2]
  c= c[,1]/c[,2]
  c= abs(log2(c))
  
  d[['prot']] = c
  
  c = e[,3:4]
  c= c[,1]/c[,2]
  c= abs(log2(c))
  
  d[['RNA']] = c
  
  c = e[,5:6]
  c= c[,1]/c[,2]
  c= abs(log2(c))
  
  d[['Ribo']] = c
  c =lapply(d,function(j){
    j<<-j
    
  })
  return(c)
})

pblapply(1:length(b), function(i){
  i<<-i
  b[[i]] <<- as.data.frame(b[[i]])
  return('')
})

a = do.call(rbind, b)
a = melt(a)

a$variable=factor(a$variable,levels = c('RNA','Ribo','prot'))
b = combn(as.character(unique(a$variable)),2)
b = apply(b,2,function(i){
  return(list(i[1],i[2]))
})
lapply(1:length(b),function(i){
  b[[i]]<<-unlist(b[[i]])
})

ggplot(a,aes(variable,value, fill=variable))+
  geom_boxplot()+
  scale_y_log10()+
  stat_compare_means(comparisons = b)+
  theme_classic()+
  xlab('')+
  ylab('|log2(FC)|')

```

## Euclidean distances between the profiles

Euclidean distances can also give information on how variable datasets can be. We once again used the quantile normalized data to calculate Euclidean distances between the profile in each expression level.

Consistently to the previous results, we found that the distances were lower and lower as the expression process progresses, suggesting once again that the expression variations were decreased. This also supported the presence of the PTB phenomenon

```{r PTB3}

a = dist(t(df_final2))
a = as.matrix(a)
a = as.data.frame(a)
b=lapply(c('RNA','Ribo','Prot'), function(i){
  i<<-i
  a = df_final2[,grep(i, colnames(df_final2))]
  a = dist(t(a))
  a = as.matrix(a)
  a= a[lower.tri(a)]
  return(a)
})
names(b)=  c('RNA','Ribo','Prot')
b=as.data.frame(b)
b = melt(b)

c = combn(as.character(unique(b$variable)),2)
c = apply(c,2,function(i){
  return(list(i[1],i[2]))
})
lapply(1:length(c),function(i){
  c[[i]]<<-unlist(c[[i]])
})

ggplot(b,aes(x=variable,y=value, fill=variable))+
  geom_boxplot()+
  theme_classic()+
  ylab('Euclidean distance')+
  xlab('')+
  stat_compare_means(comparisons = c)

```

## Variance comparison

A simple variance calculation can also give a clue on the variation intensity of gene expression. We calculated the variance in all dataset for each gene and found that it tended to be higher at the transcription level, lower at the protein abundance level (with the translation level being in the middle), which was in accordance with the previous exploration

```{r PTB4}

a=lapply(c('RNA','Ribo','Prot'), function(i){
  i<<-i
  a = df_final2[,grep(i, colnames(df_final2))]
  a=apply(a,1 ,var)
  return(a)
})
names(a)= c('RNA','Ribo','Prot') 
a =as.data.frame(a)
b=a
b = melt(b)
c = combn(as.character(unique(b$variable)),2)
c = apply(c,2,function(i){
  return(list(i[1],i[2]))
})
lapply(1:length(c),function(i){
  c[[i]]<<-unlist(c[[i]])
})

ggplot(b,aes(x=variable,y=value, fill=variable))+
  geom_boxplot()+
  theme_classic()+
  ylab('Variance')+
  xlab('')+
  stat_compare_means(comparisons = c)+
  scale_y_log10()

```


```{r save-transcriptomics, echo=F}
save.image(here::here('output',paste0(chap_num,"transcriptomics.rdata")))
```